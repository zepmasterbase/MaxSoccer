<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Max Soccer ⚽ | Ambassador Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Orbitron',sans-serif}
body{
  background:radial-gradient(circle at top,#1b1f4b,#070a1f);
  color:#fff;
}

/* LAYOUT */
.container{
  max-width:1400px;
  margin:auto;
  padding:4rem 2rem;
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:3rem;
}
.header h1{
  color:#ff0000;
  text-shadow:0 0 20px rgba(255,0,0,.8);
}
.logout{
  padding:.7rem 1.5rem;
  border-radius:30px;
  background:#ff0000;
  border:none;
  color:#fff;
  cursor:pointer;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:2.5rem;
  margin-bottom:3.5rem;
}

/* CARD */
.card{
  background:rgba(255,255,255,.07);
  border-radius:25px;
  padding:2rem;
  backdrop-filter:blur(20px);
  box-shadow:0 20px 50px rgba(0,0,0,.5);
  transition:.4s;
  position:relative;
}
.card:hover{
  transform:translateY(-12px);
  box-shadow:0 30px 70px rgba(255,0,0,.45);
}

/* PROMO */
.promo-code{
  font-size:1.6rem;
  color:#ff4d4d;
  text-shadow:0 0 20px rgba(255,0,0,.8);
  margin:1rem 0;
}
.copy-btn{
  margin-top:1rem;
  padding:.6rem 1.5rem;
  border:none;
  border-radius:25px;
  background:#ff0000;
  color:#fff;
  cursor:pointer;
}

/* STATS */
.stat{
  font-size:2.2rem;
  color:#ff0000;
}
.label{
  opacity:.8;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:1rem;
  border-bottom:1px solid rgba(255,255,255,.1);
  text-align:left;
  font-size:.9rem;
}

/* SHARE */
.share a{
  display:inline-block;
  margin:.4rem;
  padding:.6rem 1.2rem;
  border-radius:25px;
  background:#ff0000;
  color:#fff;
  text-decoration:none;
  font-size:.85rem;
}
</style>
</head>

<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <h1>Ambassador Dashboard ⚽</h1>
    <button class="logout" id="logoutBtn">Logout</button>
  </div>

  <!-- STATS -->
  <div class="grid">
    <div class="card">
      <div class="label">Wallet Balance</div>
      <div class="stat">$<span id="wallet">0.00</span></div>
    </div>

    <div class="card">
      <div class="label">Total Referrals</div>
      <div class="stat" id="referralsCount">0</div>
    </div>

    <div class="card">
      <div class="label">Promo Code</div>
      <div class="promo-code" id="promoCode">---</div>
      <button class="copy-btn" onclick="copyCode()">Copy Code</button>
      <div class="share" id="shareLinks"></div>
    </div>
  </div>

  <!-- REFERRALS -->
  <div class="card">
    <h3 style="margin-bottom:1rem;">Referral Earnings</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Commission</th>
        </tr>
      </thead>
      <tbody id="referralTable"></tbody>
    </table>
  </div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://iotraxlicmdyybtgmkwm.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvdHJheGxpY21keXlidGdta3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNTA1OTAsImV4cCI6MjA4MzkyNjU5MH0.f69kiDeO7h0RPwRhSzINFoiVRRFjDB_CYk4nbhl2zBA"
);

let userId = null;
let promoCode = "";

// AUTH CHECK
const session = await supabase.auth.getSession();
if(!session.data.session){
  window.location.href="login-register.html";
}else{
  userId = session.data.session.user.id;
  loadDashboard();
}

// LOAD DASHBOARD
async function loadDashboard(){
  const { data: profile } = await supabase
    .from("profiles")
    .select("promo_code,wallet_balance,total_referrals,role")
    .eq("id",userId)
    .single();

  if(profile.role !== "ambassador"){
    window.location.href="VIP.html";
    return;
  }

  promoCode = profile.promo_code;
  document.getElementById("promoCode").textContent = promoCode;
  document.getElementById("wallet").textContent = profile.wallet_balance.toFixed(2);
  document.getElementById("referralsCount").textContent = profile.total_referrals;

  generateShareLinks();
  loadReferrals();
  listenRealtime();
}

// REFERRALS
async function loadReferrals(){
  const { data } = await supabase
    .from("wallet_transactions")
    .select("amount,created_at")
    .eq("ambassador_id",userId)
    .eq("type","commission")
    .order("created_at",{ascending:false});

  const tbody = document.getElementById("referralTable");
  tbody.innerHTML = "";
  data.forEach(r=>{
    tbody.innerHTML += `
      <tr>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
        <td>$${r.amount.toFixed(2)}</td>
      </tr>`;
  });
}

// REALTIME
function listenRealtime(){
  supabase
    .channel("wallet-updates")
    .on("postgres_changes",
      {event:"INSERT",schema:"public",table:"wallet_transactions",filter:`ambassador_id=eq.${userId}`},
      ()=>loadDashboard()
    )
    .subscribe();
}

// SHARE
function generateShareLinks(){
  const link = `https://yourdomain.com/login-register.html?ref=${promoCode}`;
  document.getElementById("shareLinks").innerHTML = `
    <a href="https://wa.me/?text=Join%20Max%20Soccer%20VIP%20using%20my%20code%20${promoCode}%20${link}" target="_blank">WhatsApp</a>
    <a href="https://t.me/share/url?url=${link}&text=Use%20my%20promo%20code%20${promoCode}" target="_blank">Telegram</a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=${link}" target="_blank">Facebook</a>
  `;
}

// COPY
window.copyCode = ()=>{
  navigator.clipboard.writeText(promoCode);
  alert("Promo code copied!");
};

// LOGOUT
logoutBtn.onclick = async()=>{
  await supabase.auth.signOut();
  window.location.href="login-register.html";
};
</script>

</body>
</html>